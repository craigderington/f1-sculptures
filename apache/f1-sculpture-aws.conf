# F1 G-Force Sculpture Gallery - Apache Config for AWS Load Balancer
#
# Use this configuration when behind an AWS Application/Network Load Balancer
# that handles SSL termination.
#
# The load balancer forwards HTTP (port 80) to backend instances.
# No HTTPS redirect needed - the LB already handles that.
#
# Prerequisites:
# - Apache 2.4+
# - Required modules: proxy, proxy_http, proxy_wstunnel, headers, rewrite
#
# Enable required modules:
# sudo a2enmod proxy proxy_http proxy_wstunnel headers rewrite
#
# Place this file in: /etc/apache2/sites-available/
# Enable site: sudo a2ensite f1-sculpture-aws.conf
# Reload Apache: sudo systemctl reload apache2

<VirtualHost *:80>
    ServerName 682c40ce4e12b41065558d5a78e17d82-513218741.us-east-1.elb.amazonaws.com
    ServerAlias f1-sculptures.com www.f1-sculptures.com

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/f1-sculpture-error.log
    CustomLog ${APACHE_LOG_DIR}/f1-sculpture-access.log combined

    # Security headers (include HSTS since LB handles HTTPS)
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    # Only set HSTS if request came via HTTPS to the load balancer
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS

    # Backend API Proxy (FastAPI on port 8000)
    # IMPORTANT: More specific paths must come BEFORE general paths

    # API Documentation endpoints (must be before /api)
    ProxyPass /api/docs http://localhost:8000/docs
    ProxyPassReverse /api/docs http://localhost:8000/docs

    ProxyPass /api/redoc http://localhost:8000/redoc
    ProxyPassReverse /api/redoc http://localhost:8000/redoc

    ProxyPass /api/openapi.json http://localhost:8000/openapi.json
    ProxyPassReverse /api/openapi.json http://localhost:8000/openapi.json

    # OpenAPI spec (Swagger UI looks for this at root)
    ProxyPass /openapi.json http://localhost:8000/openapi.json
    ProxyPassReverse /openapi.json http://localhost:8000/openapi.json

    # General API routes (must be after specific /api/* routes)
    ProxyPass /api http://localhost:8000/api
    ProxyPassReverse /api http://localhost:8000/api

    ProxyPass /health http://localhost:8000/health
    ProxyPassReverse /health http://localhost:8000/health

    # WebSocket Proxy for real-time updates
    # WebSocket connections must use proxy_wstunnel module
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /ws/(.*) ws://localhost:8000/ws/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /ws/(.*) http://localhost:8000/ws/$1 [P,L]

    ProxyPass /ws ws://localhost:8000/ws
    ProxyPassReverse /ws ws://localhost:8000/ws

    # Frontend Static Files
    # Serve static files from the frontend directory
    DocumentRoot /var/www/html/f1-sculptures/frontend

    <Directory /var/www/html/f1-sculptures/frontend>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        # Enable gzip compression
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
        </IfModule>

        # Cache static assets
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType text/css "access plus 1 month"
            ExpiresByType application/javascript "access plus 1 month"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 month"
        </IfModule>
    </Directory>

    # Proxy timeout settings (for long-running requests)
    ProxyTimeout 300

    # Preserve host header (important for load balancer routing)
    ProxyPreserveHost On

    # Connection settings for WebSocket
    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>
</VirtualHost>
