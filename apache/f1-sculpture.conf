# F1 G-Force Sculpture Gallery - Apache Reverse Proxy Configuration
#
# This configuration sets up Apache as a reverse proxy for the F1 Sculpture Gallery
# Frontend (static files) and Backend API (FastAPI on port 8000)
#
# Prerequisites:
# - Apache 2.4+
# - Required modules: proxy, proxy_http, proxy_wstunnel, ssl, headers, rewrite
#
# Enable required modules:
# sudo a2enmod proxy proxy_http proxy_wstunnel ssl headers rewrite
#
# Place this file in: /etc/apache2/sites-available/
# Enable site: sudo a2ensite f1-sculpture.conf
# Reload Apache: sudo systemctl reload apache2

<VirtualHost *:80>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com

    # Redirect all HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com

    # Enable SSL/TLS
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/yourdomain.crt
    SSLCertificateKeyFile /etc/ssl/private/yourdomain.key
    SSLCertificateChainFile /etc/ssl/certs/yourdomain-chain.crt

    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on

    # Security headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/f1-sculpture-error.log
    CustomLog ${APACHE_LOG_DIR}/f1-sculpture-access.log combined

    # Backend API Proxy (FastAPI on port 8000)
    # IMPORTANT: More specific paths must come BEFORE general paths

    # API Documentation endpoints (must be before /api)
    ProxyPass /api/docs http://localhost:8000/docs
    ProxyPassReverse /api/docs http://localhost:8000/docs

    ProxyPass /api/redoc http://localhost:8000/redoc
    ProxyPassReverse /api/redoc http://localhost:8000/redoc

    ProxyPass /api/openapi.json http://localhost:8000/openapi.json
    ProxyPassReverse /api/openapi.json http://localhost:8000/openapi.json

    # General API routes (must be after specific /api/* routes)
    ProxyPass /api http://localhost:8000/api
    ProxyPassReverse /api http://localhost:8000/api

    ProxyPass /health http://localhost:8000/health
    ProxyPassReverse /health http://localhost:8000/health

    # WebSocket Proxy for real-time updates
    # WebSocket connections must use proxy_wstunnel module
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /ws/(.*) ws://localhost:8000/ws/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /ws/(.*) http://localhost:8000/ws/$1 [P,L]

    ProxyPass /ws ws://localhost:8000/ws
    ProxyPassReverse /ws ws://localhost:8000/ws

    # Frontend Static Files
    # Serve static files from the frontend directory
    DocumentRoot /var/www/f1-sculpture/frontend

    <Directory /var/www/f1-sculpture/frontend>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        # Enable gzip compression
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
        </IfModule>

        # Cache static assets
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType text/css "access plus 1 month"
            ExpiresByType application/javascript "access plus 1 month"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 month"
        </IfModule>

        # SPA fallback (if needed in future)
        # FallbackResource /index.html
    </Directory>

    # Proxy timeout settings (for long-running requests)
    ProxyTimeout 300

    # Preserve host header
    ProxyPreserveHost On

    # Connection settings for WebSocket
    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>
</VirtualHost>

# Alternative: Local Development Configuration (no SSL)
# Use this if you don't have SSL certificates yet
# Uncomment the section below and comment out the HTTPS VirtualHost above

# <VirtualHost *:80>
#     ServerName localhost
#     ServerAlias f1-sculpture.local
#
#     # Logging
#     ErrorLog ${APACHE_LOG_DIR}/f1-sculpture-error.log
#     CustomLog ${APACHE_LOG_DIR}/f1-sculpture-access.log combined
#
#     # Backend API Proxy (specific paths before general)
#     # API Documentation endpoints (must be before /api)
#     ProxyPass /api/docs http://localhost:8000/docs
#     ProxyPassReverse /api/docs http://localhost:8000/docs
#     ProxyPass /api/redoc http://localhost:8000/redoc
#     ProxyPassReverse /api/redoc http://localhost:8000/redoc
#     ProxyPass /api/openapi.json http://localhost:8000/openapi.json
#     ProxyPassReverse /api/openapi.json http://localhost:8000/openapi.json
#
#     # General API routes
#     ProxyPass /api http://localhost:8000/api
#     ProxyPassReverse /api http://localhost:8000/api
#     ProxyPass /health http://localhost:8000/health
#     ProxyPassReverse /health http://localhost:8000/health
#
#     # WebSocket Proxy
#     RewriteEngine On
#     RewriteCond %{HTTP:Upgrade} =websocket [NC]
#     RewriteRule /ws/(.*) ws://localhost:8000/ws/$1 [P,L]
#     RewriteCond %{HTTP:Upgrade} !=websocket [NC]
#     RewriteRule /ws/(.*) http://localhost:8000/ws/$1 [P,L]
#
#     ProxyPass /ws ws://localhost:8000/ws
#     ProxyPassReverse /ws ws://localhost:8000/ws
#
#     # Frontend Static Files
#     DocumentRoot /var/www/f1-sculpture/frontend
#
#     <Directory /var/www/f1-sculpture/frontend>
#         Options -Indexes +FollowSymLinks
#         AllowOverride None
#         Require all granted
#     </Directory>
#
#     ProxyTimeout 300
#     ProxyPreserveHost On
# </VirtualHost>
